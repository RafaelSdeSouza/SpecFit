{
    "collab_server" : "",
    "contents" : "# Template fitting\nrequire(forcats)\nrequire(dplyr)\nrequire(purrr)\nrequire(DEoptim)\nlibrary(dtw)\nrequire(cowplot)\n\npath <- getwd()\nsetwd(path)\n\nObsSpec0 <- read.table(\"obs_spec.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\n\n\nout <- runSpecFit(ObsSpec0)\n\nObsSpecdiff <- ObsSpec0 %>% mutate(Count = append(0,diff(Count)))\n\nb1 <- read.table(\"18Opg_151keVRes_R0_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\n\nb1diff <- b1 %>% mutate(Count = append(0,diff(Count)))\n\nb2 <- read.table(\"18Opg_151keVRes_R110_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb2diff <- b2 %>% mutate(Count = append(0,diff(Count)))\n\n\nb3 <- read.table(\"18Opg_151keVRes_R195_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb3diff <- b3 %>% mutate(Count = append(0,diff(Count)))\n\nb4 <- read.table(\"18Opg_151keVRes_R1553_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb4diff <- b4  %>% mutate(Count = append(0,diff(Count)))\n\nb5 <- read.table(\"18Opg_151keVRes_R3908_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb5diff <- b5  %>% mutate(Count = append(0,diff(Count)))\n\nb6 <- read.table(\"18Opg_151keVRes_R5944_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb6diff <- b6 %>% mutate(Count = append(0,diff(Count)))\n\n\nb7 <- read.table(\"18Opg_151keVRes_R6251_2M_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb7diff <- b7 %>% mutate(Count = append(0,diff(Count)))\n\nb8 <- read.table(\"2800_bkgd_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\nb8diff <- b8 %>% mutate(Count = append(0,diff(Count)))\n\n\nc0 <- read.table(\"background_SING.dat\",header = T) %>% setNames(c(\"w\",\"Count\"))\n\nc0diff <- c0 %>% mutate(Count = append(0,diff(Count)))\n\nh <- daubcqf(10)\nret.dwt <- denoise.dwt(c(ObsSpecdiff$Count,0),h$h.0)\nObsSpec <- ObsSpecdiff\n#%>% mutate(Count = ret.dwt$xd[-4096])\n\n\nbasis <- rbind(b1$Count,b2$Count,b3$Count,b4$Count,b5$Count,b6$Count,b7$Count,b8$Count)\n\nbkg0 <- c0$Count\n\nDiffbasis <- rbind(b1diff$Count,b2diff$Count,b3diff$Count,b4diff$Count,b5diff$Count,b6diff$Count,b7diff$Count,b8diff$Count)\n\nbkg <- c0diff$Count\n\n# Just an optimizer\n\nsimdiff <- function(par){\n  # gen <- runif(9,0,1)\n  gen <- par[1:9]\n  Nb  <- par[10]\n  Nbkg <- par[11]\n  frac <- gen/sum(gen)\n  fb <- frac[1:8]\n  fbkg <- frac[9]\n\n  out <- Nb*(fb %*% basisdiff) + Nbkg*fbkg*bkg\n  out2 <- as.numeric(out)\n  return(out2)\n}\n\n\nfitness <- function(x1,x2){\n  sum(sqrt((x1-x2)^2))\n}\n\nloss <- function(par){\n  fitness(simdiff(par),ObsSpec$Count)\n}\n\n\n\n\noutDE <- DEoptim(loss, lower = rep(0,11),\n        upper = rep(50,11),control = list(NP = 250,itermax = 800))\n\n\n\n\n\n\n\nsimAbunda <- function(par){\n  gen <- par[1:9]\n  Nb  <- par[10]\n  Nbkg <- par[11]\n  frac <- gen/sum(gen)\n  fb <- frac[1:8]\n  fbkg <- frac[9]\n  out <- Nb*(fb %*% basis) + Nbkg*fbkg*bkg0\n  out2 <- as.numeric(out)\n  return(out2)\n}\n\ngpred <- data.frame(x = ObsSpec0$w,\n                    y = simAbunda(outDE$optim$bestmem))\n\n\n\nBR <- function(x){\nvt <- x[-c(9:11)]\nvt <- vt/sum(vt)\n return(vt)\n}\nBR(outDE$optim$bestmem)*100\n\n\n\n\n\n\ngspec <- ggplot(ObsSpec0,aes(x = w, y = Count)) +\n  geom_line() +\n  geom_line(out$spec, mapping=aes(x = w, y = count),color=\"red\",linetype=\"dashed\",size=0.5) +\n  theme_cowplot() +\n  ylab(\"Counts per energy\") +\n  xlab(\"\")  + theme(axis.title.x=element_blank(),\n                    axis.text.x=element_blank(),\n                    axis.ticks.x=element_blank())\n\ngres <- ggplot(ObsSpec0,aes(x = w, y = (Count-gpred$y))) +\n  geom_line() +\n  theme_nuclear() +\n  ylab(\"Residuals\") +\n  xlab(\"Energy (keV)\")\n\npdf(\"specrec_rel.pdf\",height = 10,width = 14)\nplot_grid(gspec, gres, ncol = 1, rel_heights  = c(2.25, 1),rel_widths = c(1, 1.1),\n          align=\"v\" )\ndev.off()\n\nsink(\"out.txt\")\nprint(outDE$optim$bestmem)\nsink()\n\n",
    "created" : 1576466370824.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2599700790",
    "id" : "F2294F2E",
    "lastKnownWriteTime" : 1576467183,
    "last_content_update" : 1576467440684,
    "path" : "~/Documents/GitHub/Gate_radioactive/Template_fitting_1D/DE_spec_cluster.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}